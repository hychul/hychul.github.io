# 임의코드실행

- [개요]()
- [위협(Impact)]()
- [공격(Exploit)]()
  - [서버 어플리케이션]()
  - [클라이언트 어플리케이션]()
  - [보안 어플리케이션]()
- [취약점과 예방법]()
  - [백도어(Backdoor)]()
  - [메모리 오염(Memory Corruption)]()
  - [웹 어플리케이션 취약점]()
  - [3rd Party 취약점]()
- [방어 방법(Mitigation)]()

# 개요
임의코드실행(Arbitrary Code Execution) 취약점은 원격에서 임의코드실행을 가능하게 합니다. 이는 초래할 수 있는 최악의 보안위협이 무엇인지에 초점을 두어 정의된 명칭입니다. 공격자가 시스템 제어권을 획득할 수 있고, 내부 네트워크로 침임할 수 있는 발판을 마련할 수 있기 때문에 가장 위험한 취약점으로 분류가 됩니다.

서버 어플리케이션(Application)들이 주요 공격 대상이 될 수 있습니다. 웹 브라우저, 오피스 제품(PDF 뷰어 포함), 메신저도 피싱과 연계한 공격의 대상이 됩니다. 통상적으로 임의코드실행 취약점은 취약점을 한 가지 이상 연계하여 공격합니다. 따라서 특정 코딩 패턴을 주의하는 것만으로는 간단히 예방할 수 없습니다.

정적 타입을 사용하고, 수동 메모리 관리를 하는 Low-level 언어(예: C언어)로 작성한 코드에서는 메모리 오염/유출 등 코드실행 공격에 많이 활용되는 위험한 오류가 발생할 가능성이 높기 때문에 코드 리뷰와 심층 보안 디자인 구현에 더욱 신경을 써야 합니다. 웹 어플리케이션은 몇 가지 취약한 코딩 패턴이 간단하게 코드 실행을 허용하기 때문에 이러한 패턴들(Command Injection, Deserialization 공격 등)을 잘 숙지하고 예방하는 것이 중요합니다.

그리고 코드실행 취약점은 우리가 직접 개발하는 어플리케이션에만 존재하는 것이 아닙니다. 널리 쓰이는 OS/SW/프레임워크(Framework)/라이브러리(Library)의 취약점이 공개된 후에는 공격 시도가 급증하기 때문에 보안 패치는 즉시 진행해야 합니다. 침해사고 발생 시 공격자가 어디까지 침투할 수 있는지 확신할 수 없기 때문에 로깅(Logging)/모니터링(Monitoring)/감지/대응이 원활하게 진행 될 수 있는 인프라와 절차를 갖추고, 취약점이 공개된 직후에는 모든 시스템이 패치되기 전까지 세심한 주의를 기울여야 합니다.

# 위협(Impact)
임의 코드 실행(Arbitrary Code Execution) 취약성은 SQL Injection, Cross-site Scripting, Use After Free와 같이 보안상 문제가 있는 코드 유형을 기술적으로 구분하는 명칭이 아니라 어플리케이션 운영의 관점에서 가장 위험한 위협 자체를 나타내고 있습니다.

이 취약점이 초래하는 보안상의 위협으로는 DoS 공격, 메모리 누출, 개인정보 노출, 권한 상승 등으로 다양합니다.

구체적인 공격 시나리오로는 다음과 같은 것을 생각할 수 있습니다.

- 취약한 어플리케이션이 실행되고 있는 디바이스에 대한 원격제어권한(셸)을 획득한다.
- 제어 권한을 획득한 시스템을 경유하여 더 많은 내부 정보를 획득된다.
- 내부 정보를 활용하여 보다 검지 곤란하고 영향도 높은 공격을 실행한다.(그 범위와 수단을 예측하는 것은 매우 어려워진다.)

임의코드실행 취약점은 OS 명령어 한 줄이나 수백 바이트의 CPU 명령어 실행을 허가한 것만으로 리모트(Remote) Shell 을 만드는데 있어 충분합니다. OS가 작은 이미지로 부트 스트랩링(Boot-strapping)하여 큰 용량의 코드를 읽어들이 듯이 공격자도 작은 악성 페이로드(Payload)로 더 큰 악성 코드를 로드(Load)합니다. 따라서 취약성을 이용하여 한 번에 실행할 수 있는 내용이 적다고 해도 리모트 Shell이 한 번 실행되면 단시간 내에 완전하고 정교한 기능을 가진 말웨어(Malware)를 시스템에 설치할 수 있습니다. 최신 멀웨어는 악성코드를 메모리 상에 쉽게 로드할 수 있으며, 키보드의 타이핑 내용을 기록하고, 네트워크 통신 내용을 감시하며, 스크린 캡처(Screen Capture)도 가능합니다.

# 공격(Exploit)
앞에서 서술한 바와 같이 임의코드실행의 취약점은 사소한 것도 포함한 여러 문제가 복잡하게 연계되어 발생합니다. 코드실행의 취약점에 관한 뉴스기사에서 동시에 여러 취약점을 함께 다루는 것도 이 때문입니다. 예를 들어, 웹 어플리케이션의 SQL Injection 취약성과 DBMS의 misconfiguration 취약성이 연계됨으로써 코드 실행의 취약성을 만들어 낼 수 있습니다.

취약점의 발생 메커니즘이 다양하기 때문에 구체적인 공격기법을 언급하는 것은 매우 어렵습니다. 그렇기 때문에, 이번 강의에서는 몇 개의 케이스(Case)를 간단하게 살펴보겠습니다.

## 서버 어플리케이션
서버 어플리케이션은 항상 포트를 개방하여 입력을 받기 때문에 코드 실행 공격의 핵심 표적이 됩니다. 웹 서버, 웹 어플리케이션 뿐만 아니라 프레임워크의 특정 기능이 그 공격 대상이 되기도 합니다. 유명한 취약성 공격 툴 'Eternal Blue'에서 사용된 취약성도 SMB 프로토콜을 처리하는 일종의 서버 어플리케이션에 존재하였기 때문에, 이 취약점을 이용한 Wanna Cry 랜섬웨어(Ransomware)는 급속히 확산되었습니다.

## 클라이언트 어플리케이션
개인용 컴퓨터나 스마트폰은 많은 멀티미디어 형식을 지원합니다. 이러한 멀티미디어를 처리하는 코드는 복잡하고 메모리 처리 루틴이 많기 때문에 종종 코드 실행의 취약성을 내포합니다.

취약성이 존재하는 경우, 예를 들어 공격자는 원격으로 코드 실행을 유발하기 위해 조작된 파일이나 악성 URL을 피해자에게 전송합니다. 피해자가 조작된 문서를 취약한 소프트웨어로 열거나 공격자의 웹 페이지를 취약한 브라우저로 열면 코드 실행 취약성이 발동하여 다양한 피해를 발생시킵니다.

많은 경우 공격자는 피싱(Phishing) 콘텐츠와 연계하여 이러한 함정을 파놓습니다. 단, 이러한 사용자 상호작용(User Interaction)이 필요 없는 취약성도 있습니다. Samsung사의 스마트폰에서의 Qmage의 취약성과 Apple사의 iPhone에서의 iMessage의 취약성은, 악성 메세지를 받는 순간 발동합니다. 이러한 Exploit을 Zero-click exploit이라고 합니다.

## 보안 어플리케이션
악의적인 코드를 감지하여 제거하는 보안 어플리케이션이 공격의 대상이 될 수도 있습니다. 보안 어플리케이션은 새로 다운로드된 파일을 신속하게 검사하기 때문에 보안 어플리케이션이 사용하는 압축 해제 라이브러리 등에 코드 실행 취약성이 있으면 파일 다운로드와 동시에 공격이 발생할 수 있습니다.

# 취약점과 예방법
## 백도어(Backdoor)
취약점이라고는 부를 수 없는 문제이지만 위협의 수준은 같습니다. 디버깅(Debugging) 용도로 만든 숨겨진 계정이나 인터페이스(Interface)가 남아 있는 경우가 종종 있습니다. 고객의 지원 의뢰에 대응하기 위해 의도적으로 남겨 두는 경우도 있을 수 있습니다. 그러나 악의적인 사용자가 이런 백도어를 찾아내는 것은 시간 문제입니다. 출시 시에는 반드시 백도어를 삭제해야 합니다.

## 메모리 오염(Memory Corruption)
정적 유형을 사용하여 수동 메모리 관리를 하는 Low-level 언어로 작성한 코드에서는 메모리 오염 유출 등 코드 실행 Exploit에 많이 이용되는 위험한 오류가 발생할 가능성이 높습니다.

최신 개발 환경은 보안 상 취약한 코드를 지적해 주는 기능이 있지만 멀티스레드(Multi-thread) 어플리케이션에서는 컴파일러(Compiler)가 지적할 수 없는 미묘한 오류가 많이 존재합니다. 또, 지적 자체가 무시되는 일도 많이 있습니다.

이들 코드는 주로 임베디드 소프트웨어, 미디어 처리, 웹 브라우저 개발 시에 많이 발생할 것으로 예상됩니다. 위협을 최소화하기 위해서는 보안진단을 철저히 하고 심층보안(최소권한 부여, 샌드박스 등)을 실현해야 합니다.

## 웹 어플리케이션 취약점
웹 어플리케이션에서는 메모리 오염이 생길 가능성이 매우 낮습니다. 하지만, 몇 가지 취약한 코딩 패턴들이 코드 실행을 허용하기 때문에 이런 패턴들을 파악해야 됩니다.

## Command Injection
사용자 입력 값을 무결처리(sanitize)하지 않고 OS 명령으로 사용할 때 발생하는 취약성입니다. 이러한 문제를 내포하지 않도록 확인할 필요가 있습니다.

## 역직렬화(Deserialization)
사용자 입력 값을 Serialized Object로 저장하고 이를 역직렬화하는 과정은 전혀 예측할 수 없는 실행 플로우(Flow)를 유발할 수 있으며 최악의 경우 임의 코드 실행을 허용합니다. 이러한 문제를 내포하지 않도록 확인할 필요가 있습니다.

## Web Shell
Web Shell이란 OS 명령을 실행시키는 웹 페이지를 의미합니다. PHP, JSP와 같은 서버 측 스크립트 파일을 허용하는 환경에서는 해당 스크립트 언어로 만들어진 Web Shell 코드를 공격자가 주입할 수 있고 원격 코드 실행을 허가하기 때문에 주의가 필요합니다.

기본적으로는 웹 어플리케이션 쪽에서 OS명령을 실행하는 함수를 모두 비활성화 시키셔야 되겠습니다. 그리고 스크립트로 처리되는 파일이 디렉토리에 무단으로 업로드가 되었는지 않았는지 감시하십시오.

## 파일 업로드(File Upload)
사용자가 스크립트 파일을 업로드 하려고 시도하는 경우가 있습니다. 그 때 허용된 유형을 확인하시고 반드시 허용된 디렉토리에만 파일이 저장되도록 해주시기 바랍니다. 그리고 가능한 파일명은 예측할 수 없는 값으로 난독화(Obfuscation)하고 사용자에게 직접 공개하지 않는 것을 권장합니다. 또한 사용자가 업로드 한 압축 파일을 압축 해제하는 루틴이 있을 경우에는 Path Traversal 취약성이 있는지 반드시 확인하십시오.

## 임의 파일 첨부(Arbitrary File Inclusion)
사용자가 스크립트 파일을 안전한 디렉토리에 업로드한 후에 어플리케이션에서 동적으로 스크립트 파일을 로드하는 코드가 있습니다. 공격자는 이를 악용하여 자신이 업로드한 악의적인 스크립트를 로드하도록 유도할 수 있습니다.

이런 문제를 막기 위해서 사용자가 올린 파일의 실제의 경로(Path)와 파일 이름은 공개되지 않는 것이 좋습니다. 그러나, 웹 서버 접속 로그(Access Log) 등에 JavaScript 코드가 남도록 조작한 뒤, 로그 파일을 첨부할 가능성도 있습니다. 따라서 동적으로 로딩하는 스크립트 파일의 경로는 임의로 변경되지 않도록 주의가 필요합니다.

## 3rd Party 취약점
앞에서 설명한 모든 취약성은 직접 코딩하지 않은 서드파티의 코드에도 존재할 가능성이 있기 때문에 사용 시에는 주의하고, 보안 업데이트가 있을 때는 신속하게 패치해야 합니다.

# 방어 방법(Mitigation)
코드 실행의 취약성은 우리가 직접 개발하는 어플리케이션에만 존재하는 것이 아닙니다. 널리 사용되고 있는 OS/SW/프레임워크/라이브러리에는 끊임없이 취약점이 보고되고 있습니다.

아래 그림은 공격자가 OS 또는 어플리케이션의 취약점을 발견하고 패치가 완료될 때까지 위험이 어떻게 변화하는지 나타냅니다.

```
My System      [              Exposed             ][  Risk Increases Exponentially  ][   Safe   ]

Vulnerability  +-------------------------------------------------------------------------------->
                 ^                ^                ^                ^                ^
                 |                |                |                |                |
        A black hat discovers     |        Update available         |          Update applied
          * Uses covertly         |                                 |
                        A white hat discovers           Other hackers mimic, share
                                                        * Uses massiverly(WannyCry)
```

코드실행 취약점은 공개된 후에 공격시도가 급증합니다.

따라서, 취약점이 공개된 후부터 완전히 보안 패치를 마치기 전까지가 가장 위험한 기간입니다. 또한, 침해사고 발생 시 공격자가 어디까지 침투할 수 있는지 확신할 수 없기 때문에 로깅/모니터링/감지/대응이 원활하게 진행될 수 있도록 인프라와 절차를 갖추고, 취약점 공개 직후부터 모든 시스템이 패치될 때까지 세심하게 주의를 기울여야합니다.